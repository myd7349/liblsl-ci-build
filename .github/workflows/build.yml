name: liblsl

on:
  push:
  pull_request:
    types: [ opened, ready_for_review, reopened, synchronize ]

env:
  LIBLSL_VERSION: v1.16.2
  LIBLSL_COMMIT: 7e61a2ef7a25a54b54968fb5c8776054f49b028e
  BUILD_TYPE: Release
  INSTALL_PREFIX: install

jobs:
  build-apple:
    name: build-${{ matrix.config.rid }}
    if: >-
      github.event.pull_request.draft == false
    runs-on: macOS-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - rid: ios-arm64
            os: OS64

          - rid: osx
            os: MAC_UNIVERSAL

          - rid: osx-arm64
            os: MAC_ARM64

          - rid: osx-x64
            os: MAC

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Clone liblsl
        run: |
          git clone https://github.com/sccn/liblsl.git
          pushd liblsl
          git checkout ${{ env.LIBLSL_COMMIT }}
          git apply ${{ github.workspace }}/osx.patch
          popd

      - name: Run uname
        run: uname -m

      - name: Configure
        run: >
          cmake
          --debug-output
          -S liblsl
          -B build
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/toolchains/ios-cmake/ios.toolchain.cmake
          -DPLATFORM=${{ matrix.config.os }}
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_PREFIX }}
          -DLSL_BUILD_STATIC=OFF

      - name: Build & Install
        run: |
          pushd build
          make lsl
          make install
          popd

      - name: Run file command
        run: file ./${{ env.INSTALL_PREFIX }}/lib/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: liblsl-${{ env.LIBLSL_VERSION }}-${{ matrix.config.rid }}
          path: ${{ env.INSTALL_PREFIX }}
