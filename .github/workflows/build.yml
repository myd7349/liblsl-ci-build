name: liblsl

on:
  push:
  pull_request:
    types: [ opened, ready_for_review, reopened, synchronize ]

env:
  LIBLSL_VERSION: v1.16.2
  LIBLSL_COMMIT: 7e61a2ef7a25a54b54968fb5c8776054f49b028e
  BUILD_TYPE: Release
  INSTALL_PREFIX: install

jobs:
  build-apple:
    name: build-${{ matrix.config.rid }}
    if: >-
      github.event.pull_request.draft == false
    runs-on: macOS-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - rid: ios-arm64
            os: OS64

          - rid: osx
            os: MAC_UNIVERSAL

          - rid: osx-arm64
            os: MAC_ARM64

          - rid: osx-x64
            os: MAC

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Clone liblsl
        run: |
          git clone https://github.com/sccn/liblsl.git
          pushd liblsl
          git checkout ${{ env.LIBLSL_COMMIT }}
          git apply ${{ github.workspace }}/osx.patch
          popd

      - name: Run uname
        run: uname -m

      - name: Configure
        run: >
          cmake
          --debug-output
          -S liblsl
          -B build
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/toolchains/ios-cmake/ios.toolchain.cmake
          -DPLATFORM=${{ matrix.config.os }}
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_PREFIX }}
          -DLSL_BUILD_STATIC=OFF
          -DENABLE_STRICT_TRY_COMPILE=ON

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: liblsl-${{ env.LIBLSL_VERSION }}-${{ matrix.config.rid }}-config
          path: build

      - name: Build & Install
        run: |
          cmake --build build --target install --config Release -j

      - name: Run file command
        run: file ./${{ env.INSTALL_PREFIX }}/lib/*


# References:
# https://github.com/rust-skia/rust-skia/issues/466
# https://github.com/rust-skia/rust-skia/pull/502/files
# https://stackoverflow.com/questions/64830671/why-does-my-native-arm64-application-built-using-an-x86-64-build-system-fail-to
# https://stackoverflow.com/questions/11875442/cmake-fixup-bundle-creating-empty-frameworks-on-os-x
# https://stackoverflow.com/questions/31899386/cross-building-binutils-2-25-1-for-ios8-4-arm64-apple-darwin14-0-0
# https://stackoverflow.com/questions/62406876/why-is-system-encoding-and-the-default-encoding-different-net-core
